pkgname=linux-cachyos
version=6.17.7
revision=1
wrksrc="linux-${version}"
build_style=gnu-makefile
hostmakedepends="bc perl flex bison tar kmod rsync"
makedepends="elfutils-devel pahole python3 rust rust-bindgen rust-src xz zstd openssl-devel"
short_desc="CachyOS kernel with performance and scheduler patches"
maintainer="Ly-sec <itslysec@gmail.com>"
license="GPL-2.0-or-later"
homepage="https://github.com/CachyOS/linux-cachyos"
distfiles="
  https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${version}.tar.xz
  https://raw.githubusercontent.com/CachyOS/linux-cachyos/master/linux-cachyos/config>cachyos.config
  https://github.com/CachyOS/kernel-patches/raw/master/6.17/all/0001-cachyos-base-all.patch
  https://github.com/CachyOS/kernel-patches/raw/master/6.17/sched/0001-bore-cachy.patch
"
checksum="
ddf2ea0d4439e1d57136be3623102af9458f601f5b1cb77e83246e88aea09d0e
ededed3d870c1660bec6b42ba31f9f2e7b117707a2492473fefc99726e595130
f8d705562484af7581dbf1a1c5768474ab95f53747bd79cee5cbd72d9eea5d1b
5b4eaf36b22c383bdbed2887f8bc7047b9e66c3bb3477b24323bdafe88236310
"
skip_extraction="cachyos.config 0001-cachyos-base-all.patch 0001-bore-cachy.patch"

do_configure() {
    patch -Np1 < ${XBPS_SRCDISTDIR}/${pkgname%-headers}-${version}/0001-cachyos-base-all.patch
    patch -Np1 < ${XBPS_SRCDISTDIR}/${pkgname%-headers}-${version}/0001-bore-cachy.patch
    cp ${XBPS_SRCDISTDIR}/${pkgname%-headers}-${version}/cachyos.config .config
    # Set EXTRAVERSION to -cachyos
    vsed -i -e 's/^EXTRAVERSION =.*/EXTRAVERSION = -cachyos/' Makefile
    make ARCH=x86_64 olddefconfig
}

do_build() {
    make ARCH=x86_64 ${makejobs} all
}

do_install() {
    local kernver=$(make -s kernelrelease)
    # Install kernel and modules
    make ARCH=x86_64 INSTALL_MOD_PATH=${DESTDIR}/usr modules_install
    # Install kernel image - use kernver everywhere!
    install -Dm644 arch/x86/boot/bzImage ${DESTDIR}/boot/vmlinuz-${kernver}
    install -Dm644 System.map ${DESTDIR}/boot/System.map-${kernver}
    install -Dm644 .config ${DESTDIR}/boot/config-${kernver}
    # Remove firmware
    rm -rf ${DESTDIR}/usr/lib/firmware
    # Remove build/source links
    rm -f ${DESTDIR}/usr/lib/modules/${kernver}/build
    rm -f ${DESTDIR}/usr/lib/modules/${kernver}/source
}
